const fs = require('fs');
const path = require('path');

// Bible JSON íŒŒì¼ ì½ê¸°
const bibleJsonPath = '/Users/seraph/Desktop/ê°œë°œ/bible.json';
const bibleData = JSON.parse(fs.readFileSync(bibleJsonPath, 'utf-8'));

// SQL INSERT ë¬¸ ìƒì„±
const sqlStatements = [];

// ì±… ì´ë¦„ ë§¤í•‘ (ì•½ì–´ -> ì „ì²´ ì´ë¦„)
const bookNames = {
    'ì°½': 'ì°½ì„¸ê¸°', 'ì¶œ': 'ì¶œì• êµ½ê¸°', 'ë ˆ': 'ë ˆìœ„ê¸°', 'ë¯¼': 'ë¯¼ìˆ˜ê¸°', 'ì‹ ': 'ì‹ ëª…ê¸°',
    'ìˆ˜': 'ì—¬í˜¸ìˆ˜ì•„', 'ì‚¿': 'ì‚¬ì‚¬ê¸°', 'ë£»': 'ë£»ê¸°', 'ì‚¼ìƒ': 'ì‚¬ë¬´ì—˜ìƒ', 'ì‚¼í•˜': 'ì‚¬ë¬´ì—˜í•˜',
    'ì™•ìƒ': 'ì—´ì™•ê¸°ìƒ', 'ì™•í•˜': 'ì—´ì™•ê¸°í•˜', 'ëŒ€ìƒ': 'ì—­ëŒ€ìƒ', 'ëŒ€í•˜': 'ì—­ëŒ€í•˜',
    'ìŠ¤': 'ì—ìŠ¤ë¼', 'ëŠ': 'ëŠí—¤ë¯¸ì•¼', 'ì—': 'ì—ìŠ¤ë”', 'ìš¥': 'ìš¥ê¸°', 'ì‹œ': 'ì‹œí¸',
    'ì ': 'ì ì–¸', 'ì „': 'ì „ë„ì„œ', 'ì•„': 'ì•„ê°€', 'ì‚¬': 'ì´ì‚¬ì•¼', 'ë ˜': 'ì˜ˆë ˆë¯¸ì•¼',
    'ì• ': 'ì˜ˆë ˆë¯¸ì•¼ì• ê°€', 'ê²”': 'ì—ìŠ¤ê²”', 'ë‹¨': 'ë‹¤ë‹ˆì—˜', 'í˜¸': 'í˜¸ì„¸ì•„', 'ìšœ': 'ìš”ì—˜',
    'ì•”': 'ì•„ëª¨ìŠ¤', 'ì˜µ': 'ì˜¤ë°”ëŒœ', 'ìš˜': 'ìš”ë‚˜', 'ë¯¸': 'ë¯¸ê°€', 'ë‚˜': 'ë‚˜í›”',
    'í•©': 'í•˜ë°•êµ­', 'ìŠµ': 'ìŠ¤ë°”ëƒ', 'í•™': 'í•™ê°œ', 'ìŠ¥': 'ìŠ¤ê°€ë´', 'ë§': 'ë§ë¼ê¸°',
    'ë§ˆ': 'ë§ˆíƒœë³µìŒ', 'ë§‰': 'ë§ˆê°€ë³µìŒ', 'ëˆ…': 'ëˆ„ê°€ë³µìŒ', 'ìš”': 'ìš”í•œë³µìŒ', 'í–‰': 'ì‚¬ë„í–‰ì „',
    'ë¡¬': 'ë¡œë§ˆì„œ', 'ê³ ì „': 'ê³ ë¦°ë„ì „ì„œ', 'ê³ í›„': 'ê³ ë¦°ë„í›„ì„œ', 'ê°ˆ': 'ê°ˆë¼ë””ì•„ì„œ',
    'ì—¡': 'ì—ë² ì†Œì„œ', 'ë¹Œ': 'ë¹Œë¦½ë³´ì„œ', 'ê³¨': 'ê³¨ë¡œìƒˆì„œ', 'ì‚´ì „': 'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ',
    'ì‚´í›„': 'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ', 'ë”¤ì „': 'ë””ëª¨ë°ì „ì„œ', 'ë”¤í›„': 'ë””ëª¨ë°í›„ì„œ', 'ë”›': 'ë””ë„ì„œ',
    'ëª¬': 'ë¹Œë ˆëª¬ì„œ', 'íˆ': 'íˆë¸Œë¦¬ì„œ', 'ì•½': 'ì•¼ê³ ë³´ì„œ', 'ë²§ì „': 'ë² ë“œë¡œì „ì„œ',
    'ë²§í›„': 'ë² ë“œë¡œí›„ì„œ', 'ìš”ì¼': 'ìš”í•œ1ì„œ', 'ìš”ì´': 'ìš”í•œ2ì„œ', 'ìš”ì‚¼': 'ìš”í•œ3ì„œ',
    'ìœ ': 'ìœ ë‹¤ì„œ', 'ê³„': 'ìš”í•œê³„ì‹œë¡'
};

let insertCount = 0;
const batchSize = 100;
let currentBatch = [];

// JSON ë°ì´í„° íŒŒì‹±
for (const [key, text] of Object.entries(bibleData)) {
    // í‚¤ í˜•ì‹: "ì°½1:1" -> ì±…(ì°½), ì¥(1), ì ˆ(1)
    const match = key.match(/^([ê°€-í£]+)(\d+):(\d+)$/);

    if (!match) {
        console.warn(`Invalid key format: ${key}`);
        continue;
    }

    const bookAbbr = match[1];
    const chapter = parseInt(match[2]);
    const verse = parseInt(match[3]);
    const bookName = bookNames[bookAbbr] || bookAbbr;

    // SQL INSERT ë¬¸ ìƒì„±
    const escapedText = text
        .replace(/\\/g, '\\\\')  // Backslash first
        .replace(/'/g, "''");     // Single quotes

    currentBatch.push(`('${bookName}', ${chapter}, ${verse}, '${escapedText}')`);
    insertCount++;

    // ë°°ì¹˜ í¬ê¸°ì— ë„ë‹¬í•˜ë©´ SQL ë¬¸ ìƒì„±
    if (currentBatch.length >= batchSize) {
        sqlStatements.push(
            `INSERT INTO bible_texts (book_name, chapter, verse, text) VALUES\n${currentBatch.join(',\n')};`
        );
        currentBatch = [];
    }
}

// ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
if (currentBatch.length > 0) {
    sqlStatements.push(
        `INSERT INTO bible_texts (book_name, chapter, verse, text) VALUES\n${currentBatch.join(',\n')};`
    );
}

// SQL íŒŒì¼ ì €ì¥
const sqlFilePath = path.join(__dirname, 'bible-import.sql');
const sqlContent = `-- Bible Import SQL
-- Total verses: ${insertCount}

-- Clear existing data
DELETE FROM bible_texts;

-- Insert Bible verses
${sqlStatements.join('\n\n')}
`;

fs.writeFileSync(sqlFilePath, sqlContent, 'utf-8');

console.log(`âœ… SQL file created: ${sqlFilePath}`);
console.log(`ğŸ“– Total verses: ${insertCount}`);
console.log(`ğŸ“ SQL statements: ${sqlStatements.length}`);
console.log(`\nRun this command to import:`);
console.log(`npx wrangler d1 execute harash-bible-reading-db --local --file=scripts/bible-import.sql`);
